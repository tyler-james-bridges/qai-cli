name: AI QA Engineer

on:
  pull_request:
    types: [opened, synchronize, reopened]
  workflow_dispatch:
    inputs:
      url:
        description: 'URL to test (optional, defaults to PR preview URL)'
        required: false
        type: string
      focus:
        description: 'Focus area (optional): accessibility, performance, forms, mobile, all'
        required: false
        type: string
        default: 'all'

permissions:
  contents: read
  pull-requests: write
  issues: write

jobs:
  qa-test:
    runs-on: ubuntu-latest
    timeout-minutes: 20

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Dependencies
        run: |
          npm init -y
          npm install playwright @anthropic-ai/claude-code
          npx playwright install chromium --with-deps

      - name: Wait for Preview Deployment
        id: preview
        if: github.event_name == 'pull_request'
        run: |
          # Wait for Vercel/Netlify/GitHub Pages preview deployment
          # Customize this based on your deployment platform
          echo "Waiting for preview deployment..."
          sleep 30

          # Set preview URL - customize based on your platform
          # Examples:
          # Vercel: https://${{ github.event.repository.name }}-git-${{ github.head_ref }}-${{ github.repository_owner }}.vercel.app
          # Netlify: https://deploy-preview-${{ github.event.number }}--your-site.netlify.app
          # GitHub Pages: https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}

          PREVIEW_URL="${{ inputs.url || format('https://{0}.github.io/{1}', github.repository_owner, github.event.repository.name) }}"
          echo "preview_url=$PREVIEW_URL" >> $GITHUB_OUTPUT
          echo "Testing URL: $PREVIEW_URL"

      - name: Create Screenshots Directory
        run: mkdir -p screenshots

      - name: Run AI QA Engineer
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          TEST_URL: ${{ steps.preview.outputs.preview_url || inputs.url }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
          TEST_FOCUS: ${{ inputs.focus || 'all' }}
        run: |
          npx claude-code --print \
            --mcp-config .claude/mcp-config.json \
            --system-prompt "$(cat .claude/qa-engineer-prompt.md)" \
            "Test the website at $TEST_URL

             ## Test Configuration
             - Focus area: $TEST_FOCUS
             - PR Number: $PR_NUMBER

             ## Required Testing

             ### 1. Network & Console Health (First!)
             Before any visual testing:
             - Monitor for failed network requests (4xx, 5xx errors)
             - Monitor for console errors and warnings
             - Note any slow API calls (>3 seconds)
             - Check for missing resources (404s)

             ### 2. Viewport Testing
             Test on these viewports:
             - Mobile: 375x667 (iPhone SE)
             - Tablet: 768x1024 (iPad)
             - Desktop: 1920x1080 (Full HD)

             ### 3. Functional Testing
             - Test all interactive elements (buttons, links, forms)
             - Test navigation flows
             - Test any dynamic content loading
             - Try to break things - rapid clicks, edge cases

             ### 4. Visual Testing
             - Check for layout issues, overflow, cut-off text
             - Verify responsive design works across viewports
             - Check alignment and spacing

             ### 5. Accessibility
             - Tab navigation works
             - Focus states visible
             - Images have alt text

             ## Output Requirements

             1. Save screenshots to ./screenshots/ directory
             2. Create qa-report.md with:
                - Summary (bugs found, severity breakdown)
                - Network health section
                - Console output section
                - Detailed bug reports with steps to reproduce
                - Screenshots referenced by filename
                - Recommendations prioritized by impact

             Be thorough. Think like a user who wants to break things."

      - name: Upload Screenshots
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: qa-screenshots-${{ github.run_number }}
          path: screenshots/
          retention-days: 14
          if-no-files-found: ignore

      - name: Upload QA Report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: qa-report-${{ github.run_number }}
          path: qa-report.md
          retention-days: 14
          if-no-files-found: ignore

      - name: Post QA Report to PR
        if: github.event_name == 'pull_request' && always()
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');

            let report = '## ðŸ” AI QA Engineer Report\n\n';

            if (fs.existsSync('qa-report.md')) {
              const content = fs.readFileSync('qa-report.md', 'utf8');
              report += content;

              // Add artifacts link
              report += '\n\n### ðŸ“Ž Artifacts\n';
              report += `- [Screenshots](../actions/runs/${{ github.run_id }})\n`;
              report += `- [Full Report](../actions/runs/${{ github.run_id }})\n`;
            } else {
              report += 'âš ï¸ QA report was not generated. Check the [workflow logs](../actions/runs/${{ github.run_id }}) for details.';
            }

            report += '\n\n---\n';
            report += '*Automated testing by [AI QA Engineer](https://github.com/tyler-james-bridges/ai-qa-engineer) using Claude Code + Playwright*';

            // Find existing comment
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });

            const botComment = comments.find(comment =>
              comment.body.includes('AI QA Engineer Report')
            );

            if (botComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: report
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: report
              });
            }
